# GitHub Actions workflow for building and releasing VirtueMissionSolver
# Triggered on version tags (v*.*.*) - creates a draft release with Windows and macOS executables

name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  actions: read

jobs:
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS files
        run: git lfs pull

      - name: Download latest game data artifact
        id: download-data
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: update-data.yml
          name: egginc-game-data
          path: FetchData/
          if_no_artifact_found: warn

      - name: Extract compressed game data
        shell: pwsh
        run: |
          $gzFile = "FetchData/egginc_data_All.json.gz"
          $jsonFile = "FetchData/egginc_data_All.json"
          
          if (Test-Path $gzFile) {
            Write-Host "Found compressed game data artifact, extracting..."
            # Use .NET to decompress gzip
            $input = [System.IO.File]::OpenRead($gzFile)
            $output = [System.IO.File]::Create($jsonFile)
            $gzip = New-Object System.IO.Compression.GZipStream($input, [System.IO.Compression.CompressionMode]::Decompress)
            $gzip.CopyTo($output)
            $gzip.Close()
            $output.Close()
            $input.Close()
            Remove-Item $gzFile
            Write-Host "Game data extracted successfully"
            Write-Host "File size: $((Get-Item $jsonFile).Length / 1MB) MB"
          } else {
            Write-Host "No compressed artifact found, using existing egginc_data_All.json from repository"
            if (Test-Path $jsonFile) {
              Write-Host "Using repository version of game data"
            } else {
              Write-Host "WARNING: No game data file found!" -ForegroundColor Yellow
            }
          }

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller>=6.0.0

      - name: Build executable with PyInstaller
        run: |
          # Clean any previous build artifacts
          if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
          if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
          pyinstaller virtue_mission_solver.spec --noconfirm

      - name: Rename executable with version
        run: |
          $version = "${{ github.ref_name }}"
          Move-Item -Path "dist\VirtueMissionSolver.exe" -Destination "dist\VirtueMissionSolver-Windows-$version.exe"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: VirtueMissionSolver-Windows-${{ github.ref_name }}
          path: dist/VirtueMissionSolver-Windows-${{ github.ref_name }}.exe
          retention-days: 5

  build-macos:
    name: Build macOS Application
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS files
        run: git lfs pull

      - name: Download latest game data artifact
        id: download-data
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: update-data.yml
          name: egginc-game-data
          path: FetchData/
          if_no_artifact_found: warn

      - name: Extract compressed game data
        run: |
          gzFile="FetchData/egginc_data_All.json.gz"
          jsonFile="FetchData/egginc_data_All.json"
          
          if [ -f "$gzFile" ]; then
            echo "Found compressed game data artifact, extracting..."
            gunzip -f "$gzFile"
            echo "Game data extracted successfully"
            echo "File size: $(ls -lh "$jsonFile" | awk '{print $5}')"
          else
            echo "No compressed artifact found, using existing egginc_data_All.json from repository"
            if [ -f "$jsonFile" ]; then
              echo "Using repository version of game data"
            else
              echo "WARNING: No game data file found!"
            fi
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller>=6.0.0

      - name: Build application with PyInstaller
        run: |
          # Clean any previous build artifacts
          rm -rf build dist
          pyinstaller virtue_mission_solver.spec --noconfirm

      - name: Create macOS distributable
        run: |
          version="${{ github.ref_name }}"
          cd dist
          # If PyInstaller created an .app bundle, zip it; otherwise zip the executable
          if [ -d "VirtueMissionSolver.app" ]; then
            zip -r "VirtueMissionSolver-macOS-$version.zip" "VirtueMissionSolver.app"
          else
            zip "VirtueMissionSolver-macOS-$version.zip" "VirtueMissionSolver"
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: VirtueMissionSolver-macOS-${{ github.ref_name }}
          path: dist/VirtueMissionSolver-macOS-${{ github.ref_name }}.zip
          retention-days: 5

  release:
    name: Create Draft Release
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: VirtueMissionSolver-Windows-${{ github.ref_name }}
          path: dist/

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: VirtueMissionSolver-macOS-${{ github.ref_name }}
          path: dist/

      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          name: VirtueMissionSolver ${{ github.ref_name }}
          draft: true
          generate_release_notes: true
          files: |
            dist/VirtueMissionSolver-Windows-${{ github.ref_name }}.exe
            dist/VirtueMissionSolver-macOS-${{ github.ref_name }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
